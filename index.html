<html>

    <head>
	<meta charset="utf-8">
	<style>
	 body { margin: 0 }
	 canvas { width: 100% height: 100% }

	 #hud {
		position: absolute;
		width: 100%;
		height: 100%;
	 }

	 #hp {
		 position: absolute;
		 text-align: center;
		 width: 100%;
		 top: 5%;
	 }

	 #lives{
		 position: absolute;
		 left: 5%;
		 top: 5%;
	 }

	 #inventory {
		 position: absolute;
		 bottom: 5%;
		 right: 5%;
	 }

	 progress[value] {
		 /* Reset the default appearance */
		 -webkit-appearance: none;
		 -moz-appearance: none;

		 width: 250px;
		 height: 20px;
	 }

	</style>
    </head>

    <body>
	<script src="lib/three.js"></script>
	<script src="lib/tween.js"></script>
	<script src="lib/physi.js"></script>
	<script src="lib/ammo.js"></script>
	<script src="lib/threex.keyboardstate.js"></script>
	<script src="lib/threex.loop.js"></script>
	<script src="lib/OrbitControls.js"></script>
	<script src="lib/PointerLockControls.js"></script>
	<script src="gameObjects/util.js"></script>
	<script src="gameObjects/GameObject.js"></script>
	<script src="gameObjects/player.js"></script>
	<script src="gameObjects/enemies.js"></script>
	<script src="gameObjects/map.js"></script>

	<div id="hud">
		<div id="hp">
			<progress id="health" value="100" max="100"></progress>
		</div>

		<div id="lives">
			Lives: infinite
		</div>

		<div id="inventory">
			no inventory yet either
		</div>
	</div>

	<script>
	 'use strict'

	 const shadowMapRes = 4096
	 const deg_to_rad = (deg) => deg * (Math.PI / 180)

	 let gameobjects = []

	 Physijs.scripts.worker = "lib/physijs_worker.js"
	 Physijs.scripts.ammo = "ammo.js"

	 // SCENE
	 let scene = new Physijs.Scene
	 scene.setGravity(new THREE.Vector3(0,-30,0))
	 scene.background = new THREE.Color(0x3d8dcc)

	 // CAMERA
	 let camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 )

	 // RENDERER
	 let renderer = new THREE.WebGLRenderer({ antialias: true })
	 renderer.setSize( window.innerWidth, window.innerHeight )
	 document.body.appendChild( renderer.domElement )

	 renderer.shadowMap.enabled = true
	 renderer.shadowMap.type = THREE.PCFSoftShadowMap
	 renderer.shadowMap.renderReverseSided = false

	 renderer.gammaInput = true
	 renderer.gammaOutput = true

	 // LIGHTING
	 let light = new THREE.DirectionalLight(0xaa7777, 1, 100)
	 light.position.set(60,60,30)
	 light.target.position.set(4*8,6*3,4*8)

	 light.shadow.mapSize.width = shadowMapRes
	 light.shadow.mapSize.height = shadowMapRes
	 light.shadow.camera.left = -200
	 light.shadow.camera.right = 200
	 light.shadow.camera.top = 200
	 light.shadow.camera.bottom = -200
	 light.shadow.camera.near = 1
	 light.shadow.camera.far = 150
	 light.shadow.bias = 0.0001
	 light.castShadow = true

	 let light_helper = new THREE.DirectionalLightHelper(light, 5)
	 scene.add(light_helper)


	 /* let shadow_helper = new THREE.CameraHelper(light.shadow.camera)
	    scene.add(shadow_helper)
	  */

	 let light2 = new THREE.PointLight(0xff0000, 1, 100, 4)
	 light2.position.set(4*8,4*6,4*8)
	 /* light2.target.position.set(0,0,0)
	  */
	 light2.shadow.mapSize.width = shadowMapRes
	 light2.shadow.mapSize.height = shadowMapRes
	 light2.shadow.camera.left = -200
	 light2.shadow.camera.right = 200
	 light2.shadow.camera.top = 200
	 light2.shadow.camera.bottom = -200
	 light2.shadow.camera.near = 1
	 light2.shadow.camera.far = 150
	 light2.castShadow = true

	 let light2_helper = new THREE.PointLightHelper(light2, 5)
	 scene.add(light2_helper)

	 // AMBIENT LIGHT
	 let ambient = new THREE.AmbientLight(0x222222)

	 scene.add(light)
	 /* scene.add(light2)*/
	 scene.add(ambient)

	 //
	 // :::::::::::::::::::::::::::::: LOAD OBJECTS :::::::::::::::::::::::::::::
	 //

	 let player_startpos = new THREE.Vector3(16,30,16)

	 generate_map_from(
	     `0
########
########
########
####   #
####   #
####   #
####   #
########
1
########
#Z<##  #
# S    #
#      #
#      #
#      #
# ###  #
########
2
########
#      #
#  _   #
#  _-- #
#  _   #
#  _   #
#      #
########
3
########
#      #
#    ###
#     _#
#  _  _#
#  #  ^#
#      #
########
4
########
#      #
#  .  <#
#  .   #
#   .  #
#  Z   #
#     _#
########
	     `,
	     scene, gameobjects, (startpos) => player_startpos = startpos)

	 let camera_controls = new THREE.PointerLockControls(camera)

	 setup_pointer_lock(() => {
	     camera_controls.enabled = true;
	 }, () => {
	     camera_controls.enabled = false;
	 });

	 let player = new Player(camera_controls)
	 gameobjects.push(player)
	 player.spawnpoint = player_startpos
	 player.respawn()
	 scene.add(player.model)

	 // ORBIT CONTROLS
	 /* let controls = new THREE.OrbitControls( camera, renderer.domElement )
	    scene.add(camera)*/

	 // KEYBOARD
	 let keyboard = new THREEx.KeyboardState()

	 // ANIM LOOP
	 const animate = () => {
	     gameobjects.map(o => o.animate())
	     renderer.render(scene, camera)
	 }

	 // ::::::::::::::::: UPDATE LOOP ::::::::::::::::::

	 const update = () => {
	     gameobjects.map(o => o.update(keyboard, scene))
	     scene.simulate()
	 }

	 scene.addEventListener('update', () => {
	 })

	 //
	 // :::::::::::::: UTIL FUNCTIONS ::::::::::::::::::::
	 //

	 let animLoop = new THREEx.RenderingLoop()
	 let physLoop = new THREEx.PhysicsLoop(60)

	 animLoop.add(animate)
	 physLoop.add(update)

	 animLoop.start()
	 physLoop.start()


	</script>
    </body>

</html>
