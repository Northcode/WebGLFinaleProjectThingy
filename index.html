<html>

    <head>
	<meta charset="utf-8">
	<style>
	 body { margin: 0 }
	 canvas { width: 100% height: 100% }

	 #hud {
		position: absolute;
		width: 100%;
		height: 100%;
	 }

	 #hp {
		 position: absolute;
		 text-align: center;
		 width: 100%;
		 top: 5%;
	 }

	 #lives{
		 position: absolute;
		 left: 4%;
		 top: 5%;

		 padding: 20px;
		 border-radius: 5px;
		 border-color: rgba(10, 10, 10, 0.5);
		 border-width: 5px;
		 background: rgba(20, 20, 20, 0.5);

		 color: rgb( 200, 200, 200);
		 font-family: verdana;
		 font-size: 150%;
	 }

	 #inventory {
		 position: absolute;
		 bottom: 10%;
		 right: 5%;
		 padding-left: 20px;
		 padding-right: 20px;
		 padding-top: 10px;
		 padding-bottom: 10px;
		 border-radius: 5px;

		 color: rgb( 200, 200, 200);
		 font-family: verdana;
		 font-size: 120%;

		 width: auto;
		 height: auto;
		 background-color: rgba(20, 20, 20, 0.5);
	 }

	 #blocker {
		 position: absolute;
		 width: 100%;
		 height: 100%;

		 background-color: rgba(0,0,0,0.5);
	 }

	 #instructions {
		 width: 100%;
		 height: 100%;

		 display: -webkit-box;
		 display: -moz-box;
		 display: box;

		 -webkit-box-orient: horizontal;
		 -moz-box-orient: horizontal;
		 box-orient: horizontal;

		 -webkit-box-pack: center;
		 -moz-box-pack: center;
		 box-pack: center;

		 -webkit-box-align: center;
		 -moz-box-align: center;
		 box-align: center;

		 color: #ffffff;
		 text-align: center;
		 font-family: verdana;
		 font-size: 150%;

		 cursor: pointer;
	 }

	 #crosshair {
		 position: absolute;
		 width: 10px;
		 height: 10px;
		 top: 50%;
		 left: 50%;

  		 margin-top: -20px;
  		 margin-left: -10px;
		 text-align: center;

		 font-size: 24pt;
		 color: #ffffff;
	 }

	 progress[value] {
		 -webkit-appearance: none;
		 -moz-appearance: none;

		 width: 400px;
		 height: 30px;

		 border-radius: 50px;
		 background: LightSlateGrey;
		 border: none;
	 }

	 progress::-moz-progress-bar { background: LimeGreen ; border-radius: 50px; }
	 progress::-webkit-progress-value { background: LimeGreen ; border-radius: 50px; }
	 progress { color: LimeGreen ; border-radius: 50px; }

	</style>
    </head>

	<body>

		<div id="blocker">
			<div id="instructions">
			</div>
		</div>
		<div id="crosshair">
			+
		</div>

		<script src="lib/three.js"></script>
		<script src="lib/tween.js"></script>
		<script src="lib/physi.js"></script>
		<script src="lib/ammo.js"></script>
		<script src="lib/threex.keyboardstate.js"></script>
		<script src="lib/threex.loop.js"></script>
		<script src="lib/OrbitControls.js"></script>
		<script src="lib/PointerLockControls.js"></script>
		<script src="gameObjects/util.js"></script>
		<script src="gameObjects/GameObject.js"></script>
		<script src="gameObjects/movables.js"></script>
		<script src="gameObjects/player.js"></script>
		<script src="gameObjects/enemies.js"></script>
		<script src="gameObjects/items.js"></script>
		<script src="gameObjects/map.js"></script>
		<script src="gameObjects/levelmanager.js"></script>

		<div id="hud">
			<div id="hp">
				<progress id="health" value="100" max="100"></progress>
			</div>

			<div id="lives">
			</div>

			<div id="inventory">
				Inventory: </br></br>
				<div id="inventory-content">
				</div>
			</div>
		</div>

	<script>
	 'use strict'

	 const shadowMapRes = 4096
	 const deg_to_rad = (deg) => deg * (Math.PI / 180)
	 let clock = new THREE.Clock();
	 let screenBlocker = document.getElementById('blocker')
	 let instructions = document.getElementById('instructions')
	 instructions.innerHTML = "Click anywhere on the screen to begin"

	 let paused = false

	 let gameobjects = []

	 Physijs.scripts.worker = "lib/physijs_worker.js"
	 Physijs.scripts.ammo = "ammo.js"

	 // SCENE
	 let scene = new Physijs.Scene
	 scene.setGravity(new THREE.Vector3(0,-30,0))
	 scene.background = new THREE.Color(0x3d8dcc)

	 // CAMERA
	 let camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 )

	 // SOUND
	 let audioListener = new THREE.AudioListener()
	 camera.add(audioListener)
	 let audioLoader = new THREE.AudioLoader()

	 let backgroundmusic = new THREE.Audio(audioListener)
	 audioLoader.load('assets/music/177830__trebblofang__horror-atmosphere-background.flac', buffer =>{
		 backgroundmusic.setBuffer(buffer)
		 backgroundmusic.setVolume(0.6)
	 })

	 let zombiehurtsound = new THREE.Audio(audioListener)
	 audioLoader.load('assets/music/350919__cabled-mess__hurt-c-05.wav', buffer =>{
		 zombiehurtsound.setBuffer(buffer)
		 zombiehurtsound.setVolume(0.8)
	 })

	 // RENDERER
	 let renderer = new THREE.WebGLRenderer({ antialias: true })
	 renderer.setSize( window.innerWidth, window.innerHeight )
	 document.body.appendChild( renderer.domElement )

	 renderer.shadowMap.enabled = true
	 renderer.shadowMap.type = THREE.PCFSoftShadowMap
	 renderer.shadowMap.renderReverseSided = false

	 renderer.gammaInput = true
	 renderer.gammaOutput = true

	 let levelmanager = new LevelManager()

	 //
	 // :::::::::::::::::::::::::::::: LOAD OBJECTS :::::::::::::::::::::::::::::
	 //

	 // KEYBOARD
	 let keyboard = new THREEx.KeyboardState()

	 levelmanager.add_level(
	     `0
##########
#####    #
#####    #
#   #    #
#####    #
#####    #
##########
##########
##########
1
##########
#S#Z#   _#
# # #    #
# . #    #
### #    #
#Z  <_  _#
# ########
#        #
##########
2
##########
#   #M Nc#
#   #.   #
#   # #. #
#   # #  #
#  #  #>c#
##########
#  M    N#
##########
3
##########
#M  #____#
#   #    #
#   #    #
#   #   _#
#N #     #
######c _#
#_>  c  _#
##########
4
##########
#   c   Z#
#        #
#        #
#   #    #
#  ##    #
#   ##   #
#        #
########D#
	     `)

	 let camera_controls = new THREE.PointerLockControls(camera)

	 setup_pointer_lock(() => {
		 if (scene.player.lives <= 0) {
		 	levelmanager.load_level(0, scene, gameobjects, camera_controls)
		 }
	     camera_controls.enabled = true;
		 screenBlocker.style.display = 'none'
	     scene.onSimulationResume()
		 paused = false
		 backgroundmusic.play()
		 physLoop.start()
	 }, () => {
	     camera_controls.enabled = false;
	     screenBlocker.style.display = 'block'
		 if (scene.player.lives > 0) {
			 document.getElementById('instructions').innerHTML = "Paused</br>Click to continue"
		 }
	     /* instructions.style.display = 'instructions'*/
		 paused = true
		 backgroundmusic.pause()
	     physLoop.stop()
	     console.log(physLoop.isRunning())
	 }, () => {
	     scene.player.onclick(keyboard, scene)
	 });

	 levelmanager.load_level(0, scene, gameobjects, camera_controls)

	 // ANIM LOOP
	 const animate = () => {
	     let delta = clock.getDelta()
		 if (paused) {
		 	delta = 0
		}else {
			TWEEN.update();
		}
	     gameobjects.map(o => o.animate(delta))
	     renderer.render(scene, camera)
	 }

	 // ::::::::::::::::: UPDATE LOOP ::::::::::::::::::

	 const update = () => {
	     gameobjects.map(o => o.update(keyboard, scene))
	     scene.simulate()
	 }

	 scene.addEventListener('update', () => {
	 })

	 //
	 // :::::::::::::: UTIL FUNCTIONS ::::::::::::::::::::
	 //

	 let animLoop = new THREEx.RenderingLoop()
	 let physLoop = new THREEx.PhysicsLoop(60)

	 animLoop.add(animate)
	 physLoop.add(update)

	 animLoop.start()
	 // physLoop.start()


	</script>
    </body>

</html>
